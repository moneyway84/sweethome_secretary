<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>ì…ì§€ ê°•ì˜ ì¹´í†¡ ì±—ë´‡ Â· MVP</title>
  <style>
    :root{
      --bg:#f5f7fb;          /* ì•± ë°°ê²½ */
      --header:#2b2d42;      /* í—¤ë” í…ìŠ¤íŠ¸ */
      --accent:#4f46e5;      /* ë²„íŠ¼/í•˜ì´ë¼ì´íŠ¸ */
      --me:#daf0ff;          /* ë‚´ ë§í’ì„  ë°°ê²½ */
      --bot:#ffffff;         /* ë´‡ ë§í’ì„  ë°°ê²½ */
      --border:#e5e7eb;      /* ê²½ê³„ì„  */
      --muted:#6b7280;       /* ë³´ì¡° í…ìŠ¤íŠ¸ */
    }
    html,body{height:100%;}
    body{
      margin:0; background:var(--bg); font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,Helvetica,Arial,sans-serif; color:#111827;
      display:flex; justify-content:center; align-items:stretch;
    }
    /* ì•± í”„ë ˆì„ (ëª¨ë°”ì¼ ìš°ì„ , ë°ìŠ¤í¬íƒ‘ë„ ì¤‘ì•™ ì •ë ¬) */
    .app{ width:100%; max-width:720px; height:100dvh; display:flex; flex-direction:column; box-shadow:0 8px 32px rgba(0,0,0,.06); background:#eef1f7; }

    /* í—¤ë” */
    .header{ position:sticky; top:0; z-index:10; background:#fff; padding:14px 16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid var(--border); }
    .avatar{ width:36px; height:36px; border-radius:999px; background:linear-gradient(135deg,#60a5fa,#34d399); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
    .title{ font-weight:700; color:var(--header); }
    .subtitle{ font-size:12px; color:var(--muted); display:flex; align-items:center; gap:6px; }
    .dot{ width:8px; height:8px; border-radius:999px; background:#22c55e; display:inline-block; }

    /* ì±„íŒ… ì˜ì—­ */
    .chat{ flex:1; overflow:auto; padding:14px 12px 90px; background:linear-gradient(180deg,#f6f8fc 0%, #eef1f7 100%); }
    .row{ display:flex; margin:10px 0; gap:8px; }
    .row.bot{ justify-content:flex-start; }
    .row.user{ justify-content:flex-end; }
    .bubble{ max-width:78%; padding:10px 12px; border-radius:16px; line-height:1.45; box-shadow:0 2px 8px rgba(0,0,0,.06); border:1px solid var(--border); word-break:keep-all; }
    .bot .bubble{ background:var(--bot); border-top-left-radius:6px; }
    .user .bubble{ background:var(--me); border-top-right-radius:6px; }
    .meta{ font-size:11px; color:var(--muted); margin-top:6px; }

    /* ì…ë ¥ ë°” */
    .composer{ position:fixed; left:50%; transform:translateX(-50%); bottom:12px; width:clamp(280px, 100%, 720px); padding:8px 10px; }
    .composer-inner{ background:#fff; border:1px solid var(--border); border-radius:999px; display:flex; align-items:center; gap:8px; padding:8px; box-shadow:0 6px 14px rgba(0,0,0,.06); }
    input[type="text"]{ border:none; outline:none; flex:1; font-size:16px; background:transparent; padding:8px; }
    button.send{ background:var(--accent); color:#fff; border:none; border-radius:999px; padding:10px 14px; font-weight:700; display:flex; align-items:center; gap:6px; }
    button.send:disabled{ opacity:.5; }

    /* íƒ€ì´í•‘ ì• ë‹ˆ */
    .typing{ display:inline-flex; gap:4px; align-items:center; }
    .typing span{ width:6px; height:6px; background:#9ca3af; border-radius:999px; display:inline-block; animation:blink 1.2s infinite; }
    .typing span:nth-child(2){ animation-delay:.2s; }
    .typing span:nth-child(3){ animation-delay:.4s; }
    @keyframes blink{ 0%,80%,100%{ opacity:.2 } 40%{ opacity:1 } }

    /* ìœ í‹¸ ë²„íŠ¼ ë°”(ì„ íƒ) */
    .quick{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 0 44px; }
    .chip{ font-size:13px; padding:8px 10px; background:#fff; border:1px solid var(--border); border-radius:999px; color:#374151; }

    /* ìŠ¤í¬ë¡¤ ë°” ì–‡ê²Œ */
    .chat::-webkit-scrollbar{ width:6px; }
    .chat::-webkit-scrollbar-thumb{ background:#c7d2fe; border-radius:999px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="avatar">LH</div>
      <div>
        <div class="title">ì…ì§€ ê°•ì‚¬ë´‡</div>
        <div class="subtitle"><i class="dot"></i> ì˜¨ë¼ì¸ Â· ëª¨ë°”ì¼ ìµœì í™”</div>
      </div>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>

    <div class="composer">
      <div class="composer-inner">
        <input id="prompt" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 6ì–µ ì–¸ë” ì‹ ì • vs ì² ì‚°)" autocomplete="off" />
        <button id="send" class="send" aria-label="ì „ì†¡">ë³´ë‚´ê¸° â¤</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // 1) í…ŒìŠ¤íŠ¸ìš© ì§€ì‹ ì¹´ë“œ (ì™€ì´í”„ë‹˜ ë§íˆ¬)
    // -----------------------------
    const KNOWLEDGE = [
      {
        topic: "ì‹ ì •í‘¸ë¥¸ë§ˆì„ vs ë„ë•íŒŒí¬íƒ€ìš´",
        user_question_examples: [
          "6ì–µ ì–¸ë”ë¡œ ì‹ ì •í‘¸ë¥¸ë§ˆì„ì´ë‘ ë„ë•íŒŒí¬íƒ€ìš´ ì¤‘ ì–´ë””ê°€ ë‚˜ì„ê¹Œìš”?",
          "ì‹ ì •í‘¸ë¥¸ë§ˆì„ì´ë‘ ë„ë•íŒŒí¬íƒ€ìš´ ë¹„êµ ì¢€ í•´ì£¼ì„¸ìš”",
          "ì² ì‚° ë„ë•íŒŒí¬íƒ€ìš´ì´ë‘ ì–‘ì²œ ì‹ ì •í‘¸ë¥¸ë§ˆì„ ì¤‘ ì¶”ì²œì€ìš”?",
          "6ì–µ ì–¸ë” ì‹ ì • vs ì² ì‚°"
        ],
        assistant_answer:
          "6ì–µ ì–¸ë” ì˜ˆì‚°ì´ë¼ë©´ í˜„ì‹¤ì ìœ¼ë¡œ ì‹ ì •í‘¸ë¥¸ë§ˆì„ 2ë‹¨ì§€ê°€ ì¡°ê¸ˆ ë” ì ‘ê·¼ì„±ì´ ì¢‹ì•„ìš” ğŸ˜Š ë„ë•íŒŒí¬íƒ€ìš´ì€ ì—­ì„¸ê¶Œ ëŒ€ë‹¨ì§€ ì¥ì ì´ ìˆì§€ë§Œ, ì‹œì„¸ê°€ 6ì–µ í›„ë°˜~7ì–µì´ë¼ ì˜ˆì‚° ì´ˆê³¼ ìœ„í—˜ì´ ìˆì–´ìš”. ì‹ ì •í‘¸ë¥¸ë§ˆì„ì€ ë²„ìŠ¤ ë…¸ì„ ì´ ë‹¤ì–‘í•˜ê³  ì´ˆí’ˆì•„ ë‹¨ì§€ë¡œ ì‹¤ê±°ì£¼ ë§Œì¡±ë„ê°€ ë†’ì•„ìš”. ì„œë¶€íŠ¸ëŸ­í„°ë¯¸ë„ ê°œë°œë„ ì¥ê¸°ì  í˜¸ì¬ë¡œ ê¸°ëŒ€ë¼ìš” ğŸ’¡"
      },
      {
        topic: "ë„ë•íŒŒí¬íƒ€ìš´ ì¥ë‹¨ì ",
        user_question_examples: [
          "ë„ë•íŒŒí¬íƒ€ìš´ ì…ì§€ ê´œì°®ë‚˜ìš”?",
          "ì² ì‚° ë„ë•íŒŒí¬íƒ€ìš´ ì¥ì ì´ ë­ì˜ˆìš”?",
          "ê´‘ëª… ë„ë•íŒŒí¬íƒ€ìš´ êµí†µ ì–´ë–¤ê°€ìš”?"
        ],
        assistant_answer:
          "ë„ë•íŒŒí¬íƒ€ìš´ì€ ê´‘ëª… ì² ì‚°ë™ í•µì‹¬ ì…ì§€ë¡œ 7í˜¸ì„  ì² ì‚°ì—­ ë„ë³´ê¶Œì´ì—ìš” ğŸš‰ ëŒ€ë‹¨ì§€ë¼ ì£¼ê±° ì•ˆì •ê° ìˆê³  ìƒê¶ŒÂ·í•™êµê°€ ë„ë³´ê¶Œì´ë¼ ìƒí™œ í¸ì˜ì„±ë„ ë†’ì•„ìš”. ë‹¤ë§Œ ì–¸ë• ë™ì„ ê³¼ ì¼ë¶€ë™ ì§€í•˜ì£¼ì°¨ì¥ ì—°ê²°ì´ ì œí•œì ì¸ ì ì€ ìœ ì˜í•´ì•¼ í•´ìš”."
      },
      {
        topic: "ì‹ ì •í‘¸ë¥¸ë§ˆì„ ì¥ë‹¨ì ",
        user_question_examples: [
          "ì‹ ì •í‘¸ë¥¸ë§ˆì„2ë‹¨ì§€ ì‚´ê¸° ì–´ë–¤ê°€ìš”?",
          "ì–‘ì²œ ì‹ ì •í‘¸ë¥¸ë§ˆì„ êµí†µ ë¶ˆí¸í•˜ì§€ ì•Šë‚˜ìš”?",
          "í‘¸ë¥¸ë§ˆì„2ë‹¨ì§€ ì…ì§€ í‰ê°€í•´ì£¼ì„¸ìš”"
        ],
        assistant_answer:
          "í‘¸ë¥¸ë§ˆì„2ë‹¨ì§€ëŠ” ì–‘ì²œêµ¬ ì‹ ì •ë™ ì™¸ê³½ì— ìœ„ì¹˜í•˜ì§€ë§Œ, ë²„ìŠ¤ ì ‘ê·¼ì„±ì´ ì¢‹ê³  ì´ˆí’ˆì•„ ë‹¨ì§€ë¼ í•™êµ° ë§Œì¡±ë„ê°€ ë†’ì•„ìš” ğŸ“š ì£¼ë³€ì— ì–‘ì²œì¤‘ì•™ë„ì„œê´€ì´ ìˆê³  ëª©ë™ í•™ì›ê°€ë„ ìì „ê±° ê±°ë¦¬ì˜ˆìš”. ë‹¤ë§Œ ì§€í•˜ì²  ì—­ì„¸ê¶Œì€ ì•„ë‹ˆê³  ì„¸ëŒ€ìˆ˜ë„ ì‘ì§€ë§Œ, ì¡°ìš©í•œ í™˜ê²½ê³¼ ì„œë¶€íŠ¸ëŸ­í„°ë¯¸ë„ ê°œë°œ í˜¸ì¬ë¡œ ì¥ê¸° ê°€ì¹˜ê°€ ê¸°ëŒ€ë¼ìš”."
      }
    ];

    // -----------------------------
    // 2) ê°„ë‹¨ ê²€ìƒ‰ ë¡œì§ (MVP)
    //    - ì§ˆë¬¸ê³¼ ê°€ì¥ ìœ ì‚¬í•œ ì¹´ë“œ ì„ íƒ
    //    - ì˜ˆì‹œ ë¬¸ì¥ ìœ ì‚¬ë„ + í† í° ê²¹ì¹¨ ì ìˆ˜
    // -----------------------------
    function normalize(text){
      return (text||"")
        .toLowerCase()
        .replace(/[\n\r]/g," ")
        .replace(/[^0-9a-zê°€-í£\s]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function tokenSet(str){
      return new Set(normalize(str).split(" ").filter(Boolean));
    }

    function jaccard(a,b){
      const A = tokenSet(a), B = tokenSet(b);
      const inter = new Set([...A].filter(x=>B.has(x))).size;
      const union = new Set([...A, ...B]).size || 1;
      return inter/union;
    }

    function bestCard(query){
      let best = {score:0, card:null};
      for(const card of KNOWLEDGE){
        let score = 0;
        // 1) í† í”½ëª… ìœ ì‚¬ë„
        score += jaccard(query, card.topic) * 0.4;
        // 2) ì˜ˆì‹œë¬¸ì¥ ì¤‘ ìµœëŒ“ê°’
        let exBest = 0;
        for(const ex of card.user_question_examples){
          exBest = Math.max(exBest, jaccard(query, ex));
        }
        score += exBest * 0.6;
        if(score > best.score){ best = {score, card}; }
      }
      return best;
    }

    // -----------------------------
    // 3) UI ìœ í‹¸
    // -----------------------------
    const chatEl = document.getElementById('chat');
    const promptEl = document.getElementById('prompt');
    const sendEl = document.getElementById('send');

    function scrollToBottom(){ chatEl.scrollTop = chatEl.scrollHeight; }

    function bubble(role, html){
      const row = document.createElement('div');
      row.className = `row ${role}`;
      row.innerHTML = `
        ${role==='bot'?'<div class="avatar" style="width:28px;height:28px;font-size:12px;">LH</div>':''}
        <div class="bubble">${html}</div>
      `;
      chatEl.appendChild(row);
      scrollToBottom();
    }

    function typingStart(){
      const row = document.createElement('div');
      row.className = 'row bot';
      row.id = 'typing-row';
      row.innerHTML = `
        <div class="avatar" style="width:28px;height:28px;font-size:12px;">LH</div>
        <div class="bubble"><span class="typing"><span></span><span></span><span></span></span></div>
      `;
      chatEl.appendChild(row);
      scrollToBottom();
    }

    function typingStop(){
      const t = document.getElementById('typing-row');
      if(t) t.remove();
    }

    function disableComposer(disabled){
      promptEl.disabled = disabled; sendEl.disabled = disabled;
    }

    // -----------------------------
    // 4) ì‘ë‹µ ìƒì„± (ë¡œì»¬ RAG â†’ ì¶”í›„ OpenAI ì—°ê²° ì§€ì )
    // -----------------------------
    async function answer(query){
      const {score, card} = bestCard(query);
      // ê°„ë‹¨ ì„ê³„ì¹˜ (0.18 ë¯¸ë§Œì´ë©´ ëª¨ë¥´ëŠ” ê±¸ë¡œ ì²˜ë¦¬)
      if(!card || score < 0.18){
        return (
          "ì§ˆë¬¸ ê°ì‚¬í•©ë‹ˆë‹¤. í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì¡°ê¸ˆë§Œ ë” ì•Œë ¤ì£¼ì‹¤ ìˆ˜ ìˆì„ê¹Œìš”? \n\n"+
          "ì˜ˆ) â€˜ì˜ˆì‚° 6ì–µ ì–¸ë” / ì‹ ì •í‘¸ë¥¸ë§ˆì„ vs ë„ë•íŒŒí¬íƒ€ìš´ / ì‹¤ê±°ì£¼ vs íˆ¬ìâ€™ì²˜ëŸ¼ìš”."
        );
      }
      return card.assistant_answer;
    }

    // â–¼â–¼â–¼ OpenAI ì—°ê²°(ì„ íƒ): ë‚˜ì¤‘ì— ì´ ë¶€ë¶„ì„ í™œì„±í™”í•˜ì„¸ìš” â–¼â–¼â–¼
    /*
    async function answerWithOpenAI(query){
      const context = KNOWLEDGE.map(k=>`[${k.topic}] ${k.assistant_answer}`).join('\n');
      const sys = `ë‹¹ì‹ ì€ ë¶€ë™ì‚° ì…ì§€ ê°•ì˜ ë³´ì¡° ê°•ì‚¬ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ì œê³µëœ ì»¨í…ìŠ¤íŠ¸ë§Œ ê·¼ê±°ë¡œ ë‹µí•˜ê³ , ëª¨ë¥´ë©´ ì¶”ê°€ ì •ë³´ë¥¼ ìš”ì²­í•˜ì„¸ìš”. ë§íˆ¬ëŠ” ì¹œì ˆí•œ í•´ìš”ì²´.`;

      const r = await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer YOUR_OPENAI_API_KEY'
        },
        body: JSON.stringify({
          model: 'gpt-5',
          messages:[
            {role:'system', content: sys},
            {role:'user', content: `ì»¨í…ìŠ¤íŠ¸:\n${context}\n\nì‚¬ìš©ì ì§ˆë¬¸:${query}`}
          ],
          temperature:0.3
        })
      });
      const data = await r.json();
      return data.choices?.[0]?.message?.content?.trim() || 'ì§€ê¸ˆì€ ì‘ë‹µì´ ì–´ë ¤ì›Œìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }
    */

    // -----------------------------
    // 5) ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€ & í€µì¹©
    // -----------------------------
    function welcome(){
      bubble('bot',
        "ì•ˆë…•í•˜ì„¸ìš”, <b>ì…ì§€ ê°•ì‚¬ë´‡</b>ì´ì—ìš” ğŸ˜Š<br/>"+
        "ìˆ˜ê°•ìƒ ì§ˆë¬¸ì„ ì™€ì´í”„ë‹˜ì˜ ê°•ì˜ ìë£Œë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.<br/>"+
        "ì˜ˆ: <i>6ì–µ ì–¸ë” ì‹ ì •í‘¸ë¥¸ë§ˆì„ vs ë„ë•íŒŒí¬íƒ€ìš´</i>"
      );
      const q = document.createElement('div');
      q.className = 'quick';
      q.innerHTML = [
        '6ì–µ ì–¸ë” ì‹ ì • vs ì² ì‚°',
        'ë„ë•íŒŒí¬íƒ€ìš´ ì¥ë‹¨ì ',
        'ì‹ ì •í‘¸ë¥¸ë§ˆì„ ì¥ë‹¨ì '
      ].map(t=>`<button class=\"chip\" data-q=\"${t}\">${t}</button>`).join('');
      chatEl.appendChild(q);
    }

    chatEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('.chip');
      if(!btn) return;
      promptEl.value = btn.dataset.q;
      sendEl.click();
    });

    // -----------------------------
    // 6) ì „ì†¡ í•¸ë“¤ëŸ¬
    // -----------------------------
    async function onSend(){
      const q = promptEl.value.trim();
      if(!q) return;
      bubble('user', escapeHtml(q));
      promptEl.value = '';
      disableComposer(true);
      typingStart();
      try{
        // ê¸°ë³¸: ë¡œì»¬ RAG
        const a = await new Promise(res=> setTimeout(async()=> res(await answer(q)), 450));
        // OpenAI ì‚¬ìš© ì‹œ ì•„ë˜ë¡œ êµì²´
        // const a = await answerWithOpenAI(q);
        typingStop();
        bubble('bot', linkify(escapeHtml(a)).replace(/\n/g,'<br/>'));
      }catch(err){
        typingStop();
        bubble('bot', 'ì£„ì†¡í•´ìš”. ì ì‹œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        console.error(err);
      }finally{
        disableComposer(false);
        promptEl.focus();
      }
    }

    // -----------------------------
    // 7) í—¬í¼: XSS ë°©ì§€ & ë§í¬ ìë™í™” (+ í…ŒìŠ¤íŠ¸)
    // -----------------------------
    function escapeHtml(str){
      return String(str).replace(/[&<>"]/g, c=>({
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;'
      })[c]);
    }
    function linkify(text){
      const urlRe = /(https?:\/\/[^\s]+)/g;
      return String(text).replace(urlRe, url=>`<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
    }

    // -----------------------------
    // 8) ë°”ì¸ë”©
    // -----------------------------
    sendEl.addEventListener('click', onSend);
    promptEl.addEventListener('keydown', (e)=>{
      if(e.key==='Enter') onSend();
    });

    // -----------------------------
    // 9) ê°„ë‹¨ í…ŒìŠ¤íŠ¸ (ì¶”ê°€)
    // -----------------------------
    function runTests(){
      const fails = [];
      const eq = (name, a, b)=>{ if(a!==b){ fails.push(`${name}: expected ${b} but got ${a}`); } };

      // escapeHtml í…ŒìŠ¤íŠ¸
      eq('escapeHtml basic', escapeHtml('<a&"b>'), '&lt;a&amp;&quot;b&gt;');
      eq('escapeHtml noop', escapeHtml('abc'), 'abc');

      // linkify í…ŒìŠ¤íŠ¸
      eq('linkify http', linkify('go http://example.com now'), 'go <a href="http://example.com" target="_blank" rel="noopener">http://example.com</a> now');

      // ê²€ìƒ‰ ë¡œì§ ìŠ¤ëª¨í¬
      const r = bestCard('6ì–µ ì–¸ë” ì‹ ì • vs ì² ì‚°');
      if(!r.card){ fails.push('bestCard returned null'); }

      return fails;
    }

    // ì‹œì‘
    welcome();
    scrollToBottom();

    // í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ê²°ê³¼ í‘œì‹œ(ì‹¤íŒ¨ ì‹œë§Œ í™”ë©´ì— í‘œì‹œ)
    const testFails = runTests();
    if(testFails.length){
      console.error('[MVP TEST] failures:', testFails);
      bubble('bot', 'âš ï¸ ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: <br>'+ testFails.map(t=>`â€¢ ${escapeHtml(t)}`).join('<br>'));
    } else {
      console.log('[MVP TEST] all passed');
    }
  </script>
</body>
</html>
